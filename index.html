<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Result Status</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;700&family=Noto+Sans+Malayalam:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #047857; /* Darker Green for text */
            --primary-bg: #10b981;    /* Bright Green for headers */
            --bg-color: #e5e5e5;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Global Header Styles (Used in Login & Result) --- */
        .header-section {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }

        .arabic {
            font-family: 'Reem Kufi', sans-serif;
            font-size: 28px;
            color: var(--primary-color);
            margin: 0;
            line-height: 1.1;
        }

        .malayalam {
            font-family: 'Noto Sans Malayalam', sans-serif;
            font-size: 16px;
            margin: 2px 0;
            font-weight: 700;
        }

        #campus {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .exam-title {
            background: var(--primary-color);
            color: white;
            display: inline-block;
            padding: 4px 15px;
            border-radius: 20px;
            font-size: 11px;
            margin-top: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* --- Search Container --- */
        .search-container {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 25px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
            margin-bottom: 20px;
            box-sizing: border-box;
            border-top: 5px solid var(--primary-bg);
        }

        input {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 2px solid #eee;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            text-align: center;
            background: #f9f9f9;
            transition: 0.3s;
        }
        
        input:focus {
            background: #fff;
            border-color: var(--primary-bg);
            outline: none;
        }

        button.search-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-bg);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);
        }

        /* --- THE STATUS CARD (Optimized for Mobile Screen) --- */
        #progressCardContainer {
            display: none;
            width: 100%;
            max-width: 380px; 
            margin: 0 auto;
        }

        .result-card {
            background: white;
            width: 100%;
            padding: 15px; 
            border-radius: 0;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        /* Dashed line only for Result Card header */
        .result-card .header-section {
            border-bottom: 2px dashed #eee;
        }

        /* Decorative top bar for Result Card */
        .result-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: var(--primary-bg);
        }

        /* --- Student Info (Compact Grid) --- */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            background: #f0fdf4;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .info-item span {
            display: block;
            color: #666;
            font-size: 10px;
        }
        .info-item strong {
            display: block;
            color: #000;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Table (Condensed) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: #eee;
            padding: 6px 4px;
            text-align: center;
            font-size: 11px;
            color: #444;
        }

        td {
            border-bottom: 1px solid #f0f0f0;
            padding: 6px 4px;
            text-align: center;
        }

        .subject-col { text-align: left; padding-left: 8px; font-weight: 600; }
        
        tr.failed-row { background-color: #fff1f2; color: #e11d48; }
        
        /* --- Footer / Status --- */
        .footer-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 2px solid #eee;
            font-weight: bold;
            font-size: 13px;
        }

        .final-status {
            margin-top: 10px;
            padding: 8px;
            text-align: center;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .pass { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .fail { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .disclaimer {
            text-align: center;
            font-size: 8px;
            color: #aaa;
            margin-top: 8px;
        }

        /* --- Action Buttons --- */
        .actions {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: none;
            justify-content: center;
            gap: 10px;
            z-index: 100;
        }

        .btn-action {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-img { background: #25D366; color: white; } /* WhatsApp Green */
        .btn-pdf { background: #3b82f6; color: white; }
        .btn-new { background: #64748b; color: white; flex: 0 0 50px;}

        /* Print Hide */
        @media print {
            .search-container, .actions { display: none !important; }
            #progressCardContainer { display: block !important; }
            .result-card { border: none; box-shadow: none; }
        }
    </style>
</head>
<body>

    <div id="searchField" class="search-container">
        <div class="header-section">
            <h1 class="arabic">ŸÖÿØÿ±ÿ≥ÿ© ŸáÿØÿßŸäÿ© ÿßŸÑŸÖÿ§ŸÖŸÜŸäŸÜ</h1>
            <h2 class="malayalam">‡¥π‡¥ø‡¥¶‡¥æ‡¥Ø‡¥§‡µç‡¥§‡µÅ‡µΩ ‡¥Æ‡µÅ‡¥Ö‡µç‡¥Æ‡¥ø‡¥®‡µÄ‡µª ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏</h2>
            <div id="campus">PMSA Orphanage Campus Kattilangadi</div>
            <div class="exam-title">Result Portal</div>
        </div>

        <div style="margin-top: 20px;">
            <input type="number" id="searchAdnumber" placeholder="Enter Admission Number">
            <input type="text" id="searchClass" placeholder="Enter Class">
            <input type="text" id="searchDivision" placeholder="Enter Division">
            <button id="searchBtn" class="search-btn">Check Result</button>
        </div>
    </div>

    <div id="progressCardContainer">
        </div>
    
    <div style="height: 80px;"></div>

    <div id="actionButtons" class="actions">
        <button class="btn-action btn-new" onclick="gotoSearch()">
            üîÑ
        </button>
        <button class="btn-action btn-pdf" onclick="downloadPDF()">
            PDF
        </button>
        <button class="btn-action btn-img" onclick="downloadImage()">
            üì∏ Save PNG
        </button>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        document.getElementById("searchBtn").addEventListener("click", async () => {
            const btn = document.getElementById("searchBtn");
            const adnumber = document.getElementById("searchAdnumber").value.trim();
            const studentClass = document.getElementById("searchClass").value.trim();
            const division = document.getElementById("searchDivision").value.trim();

            if (!adnumber || !studentClass || !division) {
                alert("‚ö†Ô∏è Enter all details."); return;
            }

            if (parseInt(adnumber) === 4789 && division === "admin") {
                window.location.href = "csvparse.html"; return;
            }

            btn.textContent = "Loading...";
            
            try {
                const q = query(
                    collection(db, "studentMarks"),
                    where("adnumber", "==", adnumber),
                    where("class", "==", studentClass),
                    where("division", "==", division)
                );

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alert("‚ùå Result not found.");
                    btn.textContent = "Check Result";
                    return;
                }

                let studentData = [];
                let studentInfo = {};

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (Array.isArray(data.subjects)) {
                        data.subjects.forEach(sub => {
                            studentData.push(sub);
                        });
                    }
                    studentInfo = {
                        name: data.name,
                        class: data.class,
                        division: data.division,
                        adnumber: data.adnumber
                    };
                });

                renderCard(studentInfo, studentData);

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            } finally {
                btn.textContent = "Check Result";
            }
        });

        function renderCard(info, marks) {
            let total = 0, obt = 0, failed = false;

            const rows = marks.map(m => {
                const grade = getGrade(m.maxMark, m.obtMark);
                const passed = m.obtMark >= 18;
                if(!passed) failed = true;
                
                total += parseInt(m.maxMark);
                obt += parseInt(m.obtMark);

                return `
                <tr class="${passed ? '' : 'failed-row'}">
                    <td class="subject-col">${m.subject}</td>
                    <td>${m.maxMark}</td>
                    <td>${m.obtMark}</td>
                    <td><b>${grade}</b></td>
                </tr>`;
            }).join('');

            const percent = total > 0 ? ((obt/total)*100).toFixed(1) : 0;
            const statusHtml = failed 
                ? `<div class="final-status fail">Needs Improvement</div>` 
                : `<div class="final-status pass">üéâ Passed Successfully</div>`;

            const html = `
            <div class="result-card" id="captureTarget">
                <div class="header-section">
                    <h1 class="arabic">ŸÖÿØÿ±ÿ≥ÿ© ŸáÿØÿßŸäÿ© ÿßŸÑŸÖÿ§ŸÖŸÜŸäŸÜ</h1>
                    <h2 class="malayalam">‡¥π‡¥ø‡¥¶‡¥æ‡¥Ø‡¥§‡µç‡¥§‡µÅ‡µΩ ‡¥Æ‡µÅ‡¥Ö‡µç‡¥Æ‡¥ø‡¥®‡µÄ‡µª ‡¥Æ‡¥¶‡µç‡¥∞‡¥∏</h2>
                    <div id="campus">PMSA Orphanage Campus Kattilangadi</div>
                    <div class="exam-title">Annual Result 2024-25</div>
                </div>

                <div class="info-grid">
                    <div class="info-item"><span>Name</span><strong>${info.name}</strong></div>
                    <div class="info-item"><span>Adm No</span><strong>${info.adnumber}</strong></div>
                    <div class="info-item"><span>Class</span><strong>${info.class} - ${info.division}</strong></div>
                    <div class="info-item"><span>Result Date</span><strong>${new Date().toLocaleDateString()}</strong></div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th style="text-align:left; padding-left:8px;">Subject</th>
                            <th>Max</th>
                            <th>Obt</th>
                            <th>Grd</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>

                <div class="footer-summary">
                    <div>Total: ${obt}/${total}</div>
                    <div>${percent}%</div>
                </div>

                ${statusHtml}

                <div class="disclaimer">Computer Generated Result ‚Ä¢ No Signature Required</div>
            </div>`;

            document.getElementById("searchField").style.display = "none";
            const container = document.getElementById("progressCardContainer");
            container.innerHTML = html;
            container.style.display = "block";
            document.getElementById("actionButtons").style.display = "flex";
        }
    </script>

    <script>
        function gotoSearch() {
            document.getElementById("searchField").style.display = "block";
            document.getElementById("progressCardContainer").style.display = "none";
            document.getElementById("actionButtons").style.display = "none";
            document.getElementById("searchAdnumber").value = "";
        }

        // --- IMAGE DOWNLOAD FUNCTION ---
        function downloadImage() {
            const element = document.getElementById("captureTarget");
            
            html2canvas(element, {
                scale: 3, 
                useCORS: true,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Result_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }).catch(err => {
                alert("Could not generate image: " + err);
            });
        }

        function downloadPDF() {
            const element = document.getElementById("captureTarget");
            html2pdf().from(element).save("Result.pdf");
        }

        function getGrade(max, obt) {
            const p = (obt / max) * 100;
            if (p >= 90) return "A+";
            if (p >= 80) return "A";
            if (p >= 70) return "B+";
            if (p >= 60) return "B";
            if (p >= 50) return "C+";
            if (p >= 40) return "C";
            if (p >= 36) return "D+";
            return "D";
        }
    </script>
</body>
</html>
